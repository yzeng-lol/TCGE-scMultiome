
!! conda and mamba versions within the iSHARC are differet from base !!!

##################
## conda upgrading
##################

base env:

mamba 0.15.3
conda 4.11.0

## unable to update base conda
issue: Solving environment: failed with repodata from current_repodata.json
conda update -n base -c defaults conda
https://community.anaconda.cloud/t/do-i-need-to-update-conda/54664?replies_to_post_number=3

#####################
###  R_pkgs.yaml  ###
#####################

## adding package to exsitng env
if (TRUE){
## packages to be added tp yaml file later on

conda install bioconda::bioconductor-glmgampoi=1.14.0       ## for faster SCT v2 normalization
library("glmGamPoi")
packageVersion("glmGamPoi")   (1.14.0)

##############
## for copykat
conda install conda-forge::r-paralleldist=0.2.6
conda install conda-forge::r-mixtools=2.0.0
conda install conda-forge::r-mcmcpack=1.7.1

## conda install r::r-dlm     ## need to install from local
library(dlm)

### Pando  works for  seuratobject v4 only
dependencies ‘motifmatchr’, ‘glmnetUtils’, ‘bayestestR’, ‘ggpointdensity’, ‘pals’, ‘grr’ are not available for package ‘Pando’

conda install bioconda::bioconductor-motifmatchr=1.24.0
conda install conda-forge::r-glmnetutils=1.1.9
conda install conda-forge::r-bayestestr=0.15.0
conda install conda-forge::r-ggpointdensity=0.1
conda install conda-forge::r-pals=1.9
conda install conda-forge::r-grr=0.9.5
conda install bioconda::bioconductor-sparsematrixstats=1.14.0

## compatibility
## need to remove
conda install conda-forge::r-seuratobject=4.1.4    ## ensure to match seurat v4
conda install bioconda::r-signac=1.11.0    ## downgrade earlier version

## additional pkgs
conda install bioconda::bioconductor-org.hs.eg.db=3.18.0
conda install bioconda::bioconductor-limma=3.58.1

#######################
## updated on Dec 30th
conda activate /cluster/home/yzeng/miniconda3/envs/iSHARC_extra_env/f3329b00516c1f338eeb102b8b628a01_


## Issue for pando
## https://github.com/quadbio/Pando/issues/53
## suratobject and matrix version conflicts
https://github.com/satijalab/seurat/issues/8202#issue-2047511055
https://github.com/GreenleafLab/ArchR/issues/2059

seuratObject < 5.0.0  required for Pando

  > Attaching SeuratObject
    Warning: ‘SeuratObject’ (4.1.4) was built under R 4.3.1 but the current version is
    4.3.3; it is recomended that you reinstall ‘SeuratObject’ as the ABI
    for R may have changed

  > Solution: using R 4.3.0

## Issue for Matrix
ERROR: https://stackoverflow.com/questions/77487154/invalid-class-graph-object-superclass-mmatrix-not-defined-seurat-r
invalid class “Graph” object: superclass "mMatrix" not defined in
the environment of the object's class

  > Downgrading to Matrix v1.6.1 can resolve above issue, while will lead to

  > Error in .local(x, na.rm, dims, ...) :
     object 'R_sparse_marginsum' not found

     !! solution :: https://github.com/GreenleafLab/ArchR/issues/2059
     if (!require("BiocManager", quietly = TRUE))
     install.packages("BiocManager")

     BiocManager::install("TFBSTools", type = "source", force = TRUE)
     ## installed version: 1.40.0   ; don't update related packages to avoid dependencies conflicts

      !! testing: ## Matrix issue:
       Matrix::rsparsematrix(10, 5, 0.2) |> Matrix::colSums()


}

########################################
## intall local packages from dependences
R
pipe_dir="/cluster/home/yzeng/snakemake/iSHARC"
if(!require("Pando"))  devtools::load_all(paste0(pipe_dir, "/workflow/dependencies/Pando-1.0.0"))
ℹ Loading Pando
ℹ The packages `tidyverse`, `glmnetUtils`, `bayestestR`, `xgboost`, `brms`, `ggpointdensity`, `ggraph`, `tidygraph`, and `pals` are required.

###############################
##### test run on H4H  #######
###############################

#################################################
## testing on login node with internet connection
cd /cluster/home/yzeng/snakemake/iSHARC

conda activate iSHARC

## generate the DGA plots with dot -Tsvg
snakemake --snakefile /cluster/home/yzeng/snakemake/iSHARC/workflow/Snakefile \
          --configfile /cluster/home/yzeng/snakemake/iSHARC/test/config_template.yaml \
          -p --dag | dot -Tpng > /cluster/home/yzeng/snakemake/iSHARC/test/Tempate_DAG.png

## testing on login node for env installations only
## using conda-prefix specify additional envs parent folder, the names in the YAML files will be hash code !!!
## Conda can no longer find your environment with the --name flag. You’ll generally need to pass the --prefix flag along with the environment’s full path to find the environment.

snakemake --snakefile /cluster/home/yzeng/snakemake/iSHARC/workflow/Snakefile \
          --configfile /cluster/home/yzeng/snakemake/iSHARC/test/config_template.yaml \
          --conda-prefix ${CONDA_PREFIX}_extra_env \
          --use-conda --conda-create-envs-only  -c 1 -pn


## testing on login node for template
snakemake --snakefile /cluster/home/yzeng/snakemake/iSHARC/workflow/Snakefile \
          --configfile /cluster/home/yzeng/snakemake/iSHARC/test/config_template.yaml \
          --conda-prefix ${CONDA_PREFIX}_extra_env \
          --use-conda --keep-going  -c 1 -pn


#######################
## demo_3sample testing

cd /cluster/projects/tcge/scMultiome/iSHARC_demo_samples
conda activate iSHARC

snakemake --snakefile /cluster/home/yzeng/snakemake/iSHARC/workflow/Snakefile \
          --configfile /cluster/home/yzeng/snakemake/iSHARC/test/config_demo_samples.yaml \
          --unlock

snakemake --snakefile /cluster/home/yzeng/snakemake/iSHARC/workflow/Snakefile \
          --configfile /cluster/home/yzeng/snakemake/iSHARC/test/config_demo_samples.yaml \
          -p --dag | dot -Tpng > /cluster/home/yzeng/snakemake/iSHARC/test/Demo_samples_DAG.png

## dry run
snakemake --snakefile /cluster/home/yzeng/snakemake/iSHARC/workflow/Snakefile \
          --configfile /cluster/home/yzeng/snakemake/iSHARC/test/config_demo_samples.yaml \
          --conda-prefix ${CONDA_PREFIX}_extra_env \
          --use-conda --keep-going  -c 1 -pn

sbatch /cluster/home/yzeng/snakemake/iSHARC/test/sbatch_Snakefile_demo_samples.sh


########
back up
## dependencies for seurat_path

############################
############################
## R scripts testing
########################
#########################

conda activate /cluster/home/yzeng/miniconda3/envs/iSHARC_extra_env/f3329b00516c1f338eeb102b8b628a01_

conda activate /cluster/home/yzeng/miniconda3/envs/iSHARC_extra_env/0e0a9d3d76e11930207883bce2d953fd_

conda activate /cluster/home/yzeng/miniconda3/envs/iSHARC_extra_env/a5276348e5bcdffeed933e2c9ec87f31_

conda activate /cluster/home/yzeng/miniconda3/envs/iSHARC_extra_env/29c31794db0433497cfb51995c41e55a_

###############################
### for testing and fine-tuning: initialization_of_individual_sample
###############################
if(FALSE){
#########

## testing parameters parsing
# cd /cluster/home/yzeng/snakemake/iSHARC/workflow/scripts
# Rscript --vanilla initialization_of_individual_sample.R

## testing code on H4H computing node
# cd  /cluster/projects/tcge/scMultiome/iSHARC_demo_samples/

## testig interactively
## R
sample_id   = "Lung"
fbm_file = "/cluster/projects/tcge/scMultiome/iSHARC_test/arc_count/Lung/outs/filtered_feature_bc_matrix.h5"
pbm_file = "/cluster/projects/tcge/scMultiome/iSHARC_test/arc_count/Lung/outs/per_barcode_metrics.csv"
atac_file   = "/cluster/projects/tcge/scMultiome/iSHARC_test/arc_count/Lung/outs/atac_fragments.tsv.gz"
macs2_dir   = "/cluster/home/yzeng/miniconda3/envs/iSHARC/bin/macs2"
pipe_dir = "/cluster/home/yzeng/snakemake/iSHARC"

out_dir <- paste0(getwd(), "/individual_samples/", sample_id, "/") ## with forward slash at the end

}

###############################
### for testing and fine-tuning: vertical_integration_of_individual_sample
###############################
if(FALSE){
#########

## testing code on H4H computing node
# cd  /cluster/projects/tcge/scMultiome/iSHARC_demo_samples
# Rscript --vanilla /cluster/home/yzeng/snakemake/iSHARC/workflow/scripts/vertical_integration_of_individual_sample.R --sample_id Lung --initial_seurat_object /cluster/projects/tcge/scMultiome/iSHARC_test/individual_samples/Lung/Lung_initial_seurat_object.RDS --second_round_filter  TRUE --regress_cell_cycle   TRUE

## testing interactively on server
## R
sample_id   = "Met_lung"
iso_file = "/cluster/projects/tcge/scMultiome/iSHARC_demo_samples/individual_samples/Met_lung/Met_lung_initial_seurat_object.RDS"
second_round_filter = FALSE
regress_cell_cycle = TRUE
out_dir <- paste0(getwd(), "/individual_samples/", sample_id, "/") ## with forward slash at the end
}

###############################
### for testing and fine-tuning for extented_analyses_of_indiviudal_sample
###############################
if(FALSE){
#########

## testing code on H4H computing node
# cd  /cluster/projects/tcge/scMultiome/iSHARC_demo_samples
# Rscript --vanilla /cluster/home/yzeng/snakemake/iSHARC/workflow/scripts/extended_analyses_individual_sample.R --sample_id Lung --initial_seurat_object /cluster/projects/tcge/scMultiome/iSHARC_test/individual_samples/Lung/Lung_initial_seurat_object.RDS --second_round_filter  TRUE --regress_cell_cycle   TRUE

## testing interactively on server
## R
sample_id   = "Met_lung"
vio_file = "/cluster/projects/tcge/scMultiome/iSHARC_demo_samples/individual_samples/Met_lung/Met_lung_vertically_integrated_seurat_object.RDS"
pipe_dir = "/cluster/home/yzeng/snakemake/iSHARC"

out_dir <- paste0(getwd(), "/individual_samples/", sample_id, "/") ## with forward slash at the end

}





###########################
## testing locally with RDS
rm(list = ls())
setwd("/Users/yong/Library/CloudStorage/OneDrive-UHN/Projects/snakemake/iSHARC_test/individual_samples")
sample_id   = "Lung"
iso_file = "Lung_initial_seurat_object.RDS"
second_round_filter = TRUE
regress_cell_cycle = TRUE
out_dir <- paste0(getwd(), "/individual_samples/", sample_id, "/") ## with forward slash at the end

}


###############################
### for testing and fine-tuning:  horizontal_integration_of_atac_across_multiple_sample
###############################
if(FALSE){
#########
## on H4H
# cd  /cluster/projects/tcge/scMultiome/processed_data/TCGE-scMOS-PTLD
# conda activate  /cluster/home/yzeng/miniconda3/envs/iSHARC_extra_env/ebcd8f410d62ed43e71d1cebab0b3296_    ## new

#R
rm(list = ls())
setwd("/cluster/projects/tcge/scMultiome/processed_data/TCGE-scMOS-PTLD")
out_dir = paste0(getwd(), "/integration")         ## no forward slash at the end!!

sample_list <- read.table("/cluster/projects/tcge/scMultiome/raw_data/TCGE-scMOS-PTLD/samples_integrate_RLN.txt", header = T)
sample_ids <- sample_list$sample_id

pipe_dir = "/cluster/home/yzeng/snakemake/iSHARC"

####################################
## testing locally with multiple RDS
rm(list = ls())
setwd("/Users/yong/OneDrive - UHN/Projects/snakemake/iSHARC_test/PRCA")

sample_list <- read.table("sample_integrate.txt", header = T)
sample_ids <- sample_list$sample_id

out_dir <- "./integration"
pipe_dir  = "/Users/yong/OneDrive - UHN/Projects/snakemake/iSHARC"

}


###############################
### for testing and fine-tuning: vertical_integration_of_multiple_samples
###############################
if(FALSE){
#########
## on H4H
# cd  /cluster/projects/tcge/scMultiome/iSHARC_test/main_seurat
# conda activate  /cluster/home/yzeng/miniconda3/envs/iSHARC_extra_env/ebcd8f410d62ed43e71d1cebab0b3296_    ## new
#R

rm(list = ls())
setwd("/cluster/projects/tcge/scMultiome/processed_data/TCGE-scMOS-PTLD/integration")

integr_meth  = harmony
out_dir = paste0(getwd(), "/harmony")

####################################
## testing locally with multiple RDS
rm(list = ls())
setwd("/Users/yong/OneDrive - UHN/Projects/snakemake/iSHARC_test/PRCA/integration")

out_dir = getwd()
integr_meth  = "harmony"


}
